---
agent: agent
description: "코드 품질 검토 및 아키텍처 개선을 위한 리팩토링 수행"
---

코드 품질을 검토하고, 필요 시 아키텍처 원칙에 맞춰 구조를 개선합니다.

## 목적

코드의 가독성, 유지보수성, 확장성을 개선하고 프로젝트 아키텍처 원칙을 준수하도록 리팩토링을 수행합니다.

## 트리거

- PR 생성 전 코드 리뷰가 필요할 때
- 사용자가 리팩토링을 요청할 때
- Sprint 종료 전 코드 정리가 필요할 때
- 릴리즈 준비 단계
- 비즈니스 로직과 UI가 혼재되어 유지보수가 어려울 때
- 중복 코드가 발견되었을 때

## 실행 모드

| 모드 | 조건 | 동작 | 대상 |
|------|------|------|------|
| review | "리뷰만", "검토만" 지시 | 검토 + 피드백만 (수정 없음) | 변경된 파일 (git diff) |
| fix | 기본 / "수정", "리팩토링" 지시 | 검토 + 실제 수정 | 전체 코드베이스 |

### 모드별 결과물

| 모드 | 결과물 | 커밋 |
|------|--------|------|
| review | 리뷰 피드백 보고서 | 없음 |
| fix | 수정된 코드 + 결과 보고서 | 있음 |

## 결과물

### Review 모드

사용자에게 직접 피드백 제공 (파일 생성 없음)

```markdown
## 코드 리뷰 결과

### 리뷰 정보
- 리뷰 일시: YYYY-MM-DD HH:MM (Asia/Tokyo)
- 대상 브랜치: feature/xxx
- 비교 기준: main
- 변경 파일: N개 (+N/-N lines)

### 자동 검사 결과
| 항목 | 결과 |
|------|------|
| Lint | ✅ 통과 / ❌ N개 오류 |
| Type Check | ✅ 통과 / ❌ N개 오류 |
| Format | ✅ 통과 / ❌ 수정 필요 |

### 리뷰 요약
| 분류 | 개수 |
|------|------|
| Critical (필수 수정) | N |
| Major (수정 권장) | N |
| Minor (제안) | N |
| Nitpick (사소한 의견) | N |

### 상세 피드백
#### Critical
| 파일 | 라인 | 내용 |
|------|------|------|

#### Major
| 파일 | 라인 | 내용 |
|------|------|------|

### 결론
- [ ] ✅ 승인 (Approve)
- [ ] 수정 후 재검토 필요 (Request Changes)
- [ ] 논의 필요 (Comment)
```

### Fix 모드 파일 경로

```text
/docs/current_sprint/refactoringMMDDNN.md
```

> 폴더가 없으면 자동 생성합니다.

### Fix 모드 파일 형식

```markdown
# 리팩토링 결과

## 기본 정보
- 작업 일시: YYYY-MM-DD HH:MM (Asia/Tokyo)
- 대상 범위: (모듈/기능명)
- 총 변경 파일: N개

## 주요 변경 사항

| 분류 | 변경 내용 | 파일 |
|------|----------|------|
| 코드 제거 | 미사용 함수 삭제 | FileA.ts |
| 중복 제거 | 공통 함수 추출 | utils/common.ts |
| 계층 분리 | API 호출 분리 | services/apiService.ts |

## 삭제된 코드
- 총 N줄 삭제
- 미사용 파일: (목록)

## 추출된 공통 모듈
| 모듈명 | 용도 | 사용처 |
|--------|------|--------|

## TODO -> Issue 이전
| 원본 위치 | Issue 번호 | 내용 |
|----------|-----------|------|

## 테스트 결과
- 빌드: ✅ 성공
- 단위 테스트: ✅ N개 통과
- UI 테스트: ✅ N개 통과
```

## 실행 순서

### Review 모드

#### Phase 1: 변경 사항 파악

1. 변경된 파일 목록 확인
   ```bash
   git diff --name-only main
   git diff --stat main
   ```
2. 관련 PLAN 파일 확인 (컨텍스트 파악)

#### Phase 2: 자동 검사

1. 린트 검사
   ```bash
   npm run lint
   ```
2. 타입 검사
   ```bash
   npm run type-check
   ```
3. 포맷팅 검사
   ```bash
   npm run format:check
   ```

#### Phase 3: 수동 검토

1. 품질 체크리스트 기반 검토
2. 피드백 분류 및 작성
3. 리뷰 결과 보고서 생성

### Fix 모드

#### Phase 1: 사전 준비

1. STRUCTURE 문서 확인
2. 현재 테스트 커버리지 확인
3. lint/컴파일 에러 확인
4. 리팩토링 대상 목록 및 우선순위 작성
5. (대규모 변경 시) 롤백 계획 수립

#### Phase 2: 자동화 가능 정리

1. 자동 수정 도구 실행
   ```bash
   npm run lint --fix
   # 또는
   swiftlint --fix
   ```
2. 미사용 import 제거
3. 포맷팅 정리
4. 빌드 확인

#### Phase 3: 수동 코드 정리

1. 미사용 코드/주석 삭제
2. 중복 로직 -> 공통 모듈 추출
3. 대용량 파일 분리 (200줄 이상 검토, 400줄 이상 필수 분리)
4. 테스트 실행

#### Phase 4: 아키텍처 정리

1. 계층 위반 코드 식별
2. 비즈니스 로직 -> ViewModel/Service로 추출
3. 파일 위치 재배치
4. import 경로 수정
5. 순환 참조 해결
6. 테스트 실행

#### Phase 5: 검증 및 문서화

1. 전체 빌드 확인
2. 테스트 전체 실행
3. STRUCTURE 문서 업데이트
4. 리팩토링 결과 문서 작성

## 품질 체크리스트

### 1. 기능 정확성 (review/fix 공통)

| 항목 | 체크 |
|------|------|
| 요구사항 충족 | PLAN의 목표와 일치하는가? |
| 엣지 케이스 | 경계 조건, null/undefined 처리 |
| 에러 처리 | 예외 상황 적절히 처리하는가? |
| 부작용 | 의도치 않은 사이드 이펙트가 없는가? |

### 2. 미사용 코드 제거

| 대상 | 기준 | 자동화 |
|------|------|--------|
| 미사용 import | IDE/lint 경고 대상 | ✅ lint --fix |
| 미사용 변수/함수 | 호출되지 않는 코드 | ✅ lint |
| 주석 처리된 코드 | 전체 삭제 (Git 히스토리에 존재) | ❌ 수동 |
| TODO/FIXME 주석 | GitHub Issue로 이전 후 삭제 | ❌ 수동 |
| 미래용 코드 | "나중에 사용" 목적의 코드 삭제 | ❌ 수동 |

### 3. 중복 코드 제거

| 대상 | 조치 | 우선순위 |
|------|------|----------|
| 동일 로직 반복 (3회+) | 공통 함수/Extension으로 추출 | P0 |
| 유사 컴포넌트 | Generic 또는 Protocol로 통합 | P1 |
| 상수 중복 | Constants 파일로 통합 | P1 |
| 타입 중복 | Models 파일로 통합 | P1 |

### 4. 파일 크기 최적화

| 기준 | 조치 |
|------|------|
| 200줄 이상 | 분리 검토 대상 |
| 400줄 이상 | 반드시 분리 |

분리 기준:
- **View**: 순수 UI 렌더링만 담당
- **ViewModel**: 상태 관리 및 비즈니스 로직
- **Model**: 데이터 구조 정의
- **Service**: 외부 API/시스템 통신

### 5. 아키텍처 계층 점검

STRUCTURE 문서와 비교하여:

| 점검 항목 | 위반 예시 | 조치 |
|----------|----------|------|
| View → Data 직접 호출 | View 내 API 호출 | ViewModel/Service로 분리 |
| 계층 역전 | Model이 View 참조 | 의존성 방향 수정 |
| 위치 부적합 | /utils에 있는 API 코드 | /services로 이동 |
| 순환 참조 | A → B → A | 의존성 구조 재설계 |

### 6. 코드 품질

| 항목 | 체크 | 우선순위 |
|------|------|----------|
| Any 타입 | 구체적 타입으로 교체 | P0 |
| Force unwrap (!) | guard/if let으로 교체 | P0 |
| print() 문 | 삭제 또는 Logger로 교체 | P1 |
| 하드코딩 값 | 상수/환경변수로 분리 | P1 |
| 에러 처리 | do-catch 누락 확인 | P0 |
| 매직 넘버 | 의미 있는 상수로 교체 | P2 |
| 네이밍 | 변수/함수명이 의도를 명확히 표현 | P1 |
| 함수 크기 | 단일 책임 원칙 (20줄 이내 권장) | P1 |
| 복잡도 | 중첩 3단계 이내 | P1 |

## 피드백 분류 기준 (Review 모드)

| 분류 | 기준 | 예시 |
|------|------|------|
| Critical | 버그, 보안 취약점, 데이터 손실 위험 | null 참조, SQL injection |
| Major | 성능 문제, 아키텍처 위반, 테스트 누락 | N+1 쿼리, 계층 위반 |
| Minor | 가독성, 네이밍, 코드 스타일 | 변수명 불명확, 매직 넘버 |
| Nitpick | 개인 선호, 사소한 제안 | 줄바꿈, import 순서 |

## 리팩토링 금지 상황

다음 상황에서는 리팩토링을 보류합니다:

- 테스트 커버리지가 현저히 낮은 영역 (먼저 테스트 추가)
- 릴리즈 직전 핫픽스 상황
- 요구사항이 아직 확정되지 않은 기능

## 주의사항

- Review 모드: Critical/Major 이슈가 있으면 반드시 사용자에게 보고
- Fix 모드: 한 번에 너무 많은 변경 금지 (커밋 단위로 분리)
- 리팩토링과 기능 변경을 섞지 않음
- 변경 전후 동작이 동일해야 함 (행위 보존)
- 리뷰 시 건설적인 피드백 제공 (문제점 + 해결 방안)
- 관련 문서: [CLAUDE.md](../../CLAUDE.md)

## 커밋 메시지 형식

```bash
refactor: <변경 내용 요약>

# 예시
refactor: extract common validation logic
refactor: split UserProfile component
refactor: improve error handling in API service
```
